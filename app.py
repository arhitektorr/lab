
from flask import Flask, request, jsonify
import os
import re
import gspread
from google.oauth2.service_account import Credentials
import openai

# === üîë OpenAI ===
client = openai.OpenAI(api_key="")

# === üìä Google Sheets ===
scope = ["https://www.googleapis.com/auth/spreadsheets.readonly"]
creds = Credentials.from_service_account_file("credentials.json", scopes=scope)
gs_client = gspread.authorize(creds)
spreadsheet_id = "1Ao-FgsBLHau3SDH3HfjTOlmO1q16F8EBKsU46znOHgE"
sheet = gs_client.open_by_key(spreadsheet_id).sheet1
header_row = sheet.row_values(2)
rows = sheet.get_all_records(head=2, expected_headers=header_row)

# === ‚öôÔ∏è Flask App ===
app = Flask(__name__)

# === üîç GPT-–∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤ ===
def extract_keywords_from_text(text):
    response = client.chat.completions.create(
        model="gpt-4.1",
        messages=[
            {
                "role": "system",
                "content": (
                    "–¢—ã –±–æ—Ç –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–∏–∏. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–∏—à–µ—Ç, –∫–∞–∫–∏–µ –∞–Ω–∞–ª–∏–∑—ã –æ–Ω —Ö–æ—á–µ—Ç —Å–¥–∞—Ç—å ‚Äî –∫–∞–∫ —Ç–æ—á–Ω–æ, —Ç–∞–∫ –∏ –≤ —Å–≤–æ–±–æ–¥–Ω–æ–π —Ñ–æ—Ä–º–µ. "
                    "–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –ø–æ–Ω—è—Ç—å, –∫–∞–∫–∏–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –∞–Ω–∞–ª–∏–∑—ã –µ–º—É –ø–æ–¥–æ–π–¥—É—Ç, –∏ –≤–µ—Ä–Ω—É—Ç—å —Å–ø–∏—Å–æ–∫ –∏–∑ –Ω–∞–∑–≤–∞–Ω–∏–π –≤–∏—Ç–∞–º–∏–Ω–æ–≤, –º–∏–∫—Ä–æ—ç–ª–µ–º–µ–Ω—Ç–æ–≤, –≥–æ—Ä–º–æ–Ω–æ–≤ –∏–ª–∏ –¥—Ä—É–≥–∏—Ö –æ–±—Å–ª–µ–¥–æ–≤–∞–Ω–∏–π, —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é. "
                    "–í—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–π —Ç–æ–ª—å–∫–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ç–µ—Ä–º–∏–Ω—ã, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è –ø–æ–∏—Å–∫–∞. "
                    "–ù–µ –≤–∫–ª—é—á–∞–π –æ–±—â–∏–µ –∏–ª–∏ –∞–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã–µ —Å–ª–æ–≤–∞: '–æ–±—â–∏–π –∞–Ω–∞–ª–∏–∑ –∫—Ä–æ–≤–∏', '–±–∏–æ—Ö–∏–º–∏—è', '–∑–¥–æ—Ä–æ–≤—å–µ', '—á–µ–∫-–∞–ø', '–∫–æ–º–ø–ª–µ–∫—Å', '–ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å'. "
                    "–ï—Å–ª–∏ —á–µ–ª–æ–≤–µ–∫ –Ω–∞–ø–∏—Å–∞–ª '–≤–∏—Ç–∞–º–∏–Ω—ã', '—á—É–≤—Å—Ç–≤—É—é —É—Å—Ç–∞–ª–æ—Å—Ç—å', '–≤—ã–ø–∞–¥–∞—é—Ç –≤–æ–ª–æ—Å—ã' ‚Äî —Ç—ã –¥–æ–ª–∂–µ–Ω –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è –∞–Ω–∞–ª–∏–∑–æ–≤: –Ω–∞–ø—Ä–∏–º–µ—Ä '–≤–∏—Ç–∞–º–∏–Ω D, –≤–∏—Ç–∞–º–∏–Ω B12, —Ñ–µ—Ä—Ä–∏—Ç–∏–Ω, –º–∞–≥–Ω–∏–π, —Ü–∏–Ω–∫, –¢–¢–ì'. "
                    "–ï—Å–ª–∏ –∑–∞–ø—Ä–æ—Å —Å–æ–¥–µ—Ä–∂–∏—Ç —Å–∏–º–ø—Ç–æ–º—ã –∏–ª–∏ –æ—Ä–≥–∞–Ω—ã, —Ç–∞–∫–∏–µ –∫–∞–∫ '—â–∏—Ç–æ–≤–∏–¥–∫–∞', '–ø–µ—á–µ–Ω—å', '–∏–º–º—É–Ω–∏—Ç–µ—Ç', ‚Äî –ø–æ–¥–±–∏—Ä–∞–π –ø–æ–¥—Ö–æ–¥—è—â–∏–µ –æ–±—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è: –Ω–∞–ø—Ä–∏–º–µ—Ä –ø—Ä–∏ '—â–∏—Ç–æ–≤–∏–¥–∫–∞' ‚Äî '–¢–¢–ì, –¢4 —Å–≤–æ–±–æ–¥–Ω—ã–π, –¢3 —Å–≤–æ–±–æ–¥–Ω—ã–π, –∞–Ω—Ç–∏—Ç–µ–ª–∞ –∫ –¢–ü–û'. "
                    "–ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏–∞–ª—å–Ω—ã–µ –∏–ª–∏ –æ–±—â–∏–µ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏, –Ω–∞–ø—Ä–∏–º–µ—Ä '–∞–Ω–∞–ª–∏–∑ –∫—Ä–æ–≤–∏', '–∞–Ω–∞–ª–∏–∑ –º–æ—á–∏', '–≥–æ—Ä–º–æ–Ω—ã', ‚Äî –ø–æ–¥–±–∏—Ä–∞–π –Ω–∞–∏–±–æ–ª–µ–µ —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω—ë–Ω–Ω—ã–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ç–µ—Å—Ç—ã –∏–∑ —ç—Ç–æ–π –æ–±–ª–∞—Å—Ç–∏. –ù–∞–ø—Ä–∏–º–µ—Ä: "
                    "'–∞–Ω–∞–ª–∏–∑ –º–æ—á–∏' ‚Üí '–û–±—â–∏–π –∞–Ω–∞–ª–∏–∑ –º–æ—á–∏, –º–æ—á–∞ –Ω–∞ –±–µ–ª–æ–∫, –º–æ—á–∞ –Ω–∞ –≥–ª—é–∫–æ–∑—É', "
                    "'–∞–Ω–∞–ª–∏–∑ –∫—Ä–æ–≤–∏' ‚Üí '–û–±—â–∏–π –∞–Ω–∞–ª–∏–∑ –∫—Ä–æ–≤–∏, –±–∏–æ—Ö–∏–º–∏—è, –≥–ª—é–∫–æ–∑–∞, –¢–¢–ì', "
                    "'–≥–æ—Ä–º–æ–Ω—ã' ‚Üí '–¢–¢–ì, –¢4, –¢3, –ø—Ä–æ–ª–∞–∫—Ç–∏–Ω, —Ç–µ—Å—Ç–æ—Å—Ç–µ—Ä–æ–Ω'. "
                    "–û—Ç–≤–µ—Ç –≤—Å–µ–≥–¥–∞ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å—Ç—Ä–æ–≥–æ —Å–ø–∏—Å–∫–æ–º –Ω–∞–∑–≤–∞–Ω–∏–π –∞–Ω–∞–ª–∏–∑–æ–≤ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é, –±–µ–∑ –ø–æ—è—Å–Ω–µ–Ω–∏–π –∏ –±–µ–∑ –ª–∏—à–Ω–∏—Ö —Å–ª–æ–≤. "
                    "–î–∞–∂–µ –ø—Ä–∏ –Ω–µ–ø–æ–Ω—è—Ç–Ω–æ–º –∏–ª–∏ –∞–±—Å—Ç—Ä–∞–∫—Ç–Ω–æ–º –∑–∞–ø—Ä–æ—Å–µ ‚Äî –ø–æ—Å—Ç–∞—Ä–∞–π—Å—è –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ –∞–Ω–∞–ª–∏–∑—ã –ø–æ —Å–º—ã—Å–ª—É."
                )
            },
            {"role": "user", "content": text}
        ]
    )
    keywords = response.choices[0].message.content.strip()
    print("üß† GPT –≤–µ—Ä–Ω—É–ª –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞:", keywords)
    return [kw.strip().lower() for kw in keywords.split(",")]

# === üîé –ü–æ–∏—Å–∫ –ø–æ –∫–ª—é—á–∞–º ===
def contains_exact_word(text, word):
    pattern = r'\b' + re.escape(word) + r'(–∞|—É|–µ|–æ–º|—ã|–æ–≤|–∞—Ö|–∞–º)?\b'
    return re.search(pattern, text.lower())

def search_rows_by_keywords(keywords):
    matches = []
    for row in rows:
        name = str(row.get("–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ", "")).lower()
        if any(contains_exact_word(name, kw) for kw in keywords):
            matches.append(row)
    return matches

# === üåê API ===
@app.route("/analyze", methods=["POST"])
def analyze():
    user_message = request.json.get("text", "")
    if not user_message:
        return jsonify({"response": "‚ùó –ó–∞–ø—Ä–æ—Å –ø—É—Å—Ç–æ–π."})

    keywords = extract_keywords_from_text(user_message)
    print("üîë –ö–ª—é—á–∏ GPT:", keywords)

    results = search_rows_by_keywords(keywords)

    if results:
        response_lines = [
            f"{row['–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ']} ‚Äî {row['–¶–µ–Ω–∞']} —Ä—É–±. ({row['–°—Ä–æ–∫ –∏—Å–ø.']})"
            for row in results[:10]
        ]
        return jsonify({"response": "\n".join(response_lines)})
    else:
        return jsonify({"response": "‚ùå –ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –ø–æ –≤–∞—à–µ–º—É –∑–∞–ø—Ä–æ—Å—É."})

# === ‚ñ∂ –ó–∞–ø—É—Å–∫ ===
if __name__ == "__main__":
    app.run(debug=True, port=5000)
